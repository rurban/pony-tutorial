<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Calling C - Pony Tutorial</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../css/highlight.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Calling C";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 
  <script src="../../js/highlight.pack.js"></script>

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Pony Tutorial</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <ul class="subnav">
    <li><span>Getting started</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../..">Welcome!</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../getting-started/what-you-need-to-start/">What you need to start</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../getting-started/installation/">Installation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../getting-started/helloworld/">Helloworld</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../getting-started/how-it-works/">How it works</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../getting-started/whitespace/">Whitespace</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Types</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../types/static-vs-dynamic/">Static vs dynamic</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../types/classes/">Classes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../types/primitives/">Primitives</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../types/actors/">Actors</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../types/traits-and-interfaces/">Traits and interfaces</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../types/type-aliases/">Type aliases</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../types/type-expressions/">Type expressions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../types/delegates/">Delegates</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Expressions</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../expressions/variables/">Variables</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../expressions/infix-ops/">Infix ops</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../expressions/control-structures/">Control structures</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../expressions/methods/">Methods</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../expressions/exceptions/">Exceptions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../expressions/sugar/">Sugar</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../expressions/object-literals/">Object literals</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../expressions/partial-application/">Partial application</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Capabilities</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/object-capabilities/">Object capabilities</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/reference-capabilities/">Reference capabilities</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/guarantees/">Guarantees</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/aliasing/">Aliasing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/consume-and-destructive-read/">Consume and destructive read</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/recovering-capabilities/">Recovering capabilities</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/combining-capabilities/">Combining capabilities</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/passing-and-sharing/">Passing and sharing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/capability-subtyping/">Capability subtyping</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/arrow-types/">Arrow types</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../capabilities/trust-boundary/">Trust boundary</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Generics</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../generics/polymorphic-types/">Polymorphic types</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../generics/polymorphic-methods/">Polymorphic methods</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../composition-inheritance/code-sharing/">Code sharing</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Pattern Matching</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../pattern-matching/match/">Match</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../pattern-matching/as/">As</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Packages</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../packages/package-system/">Package system</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../packages/use-statement/">Use statement</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../packages/builtin/">Builtin</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../packages/platform/">Use conditions</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../compiler-clargs/clargs/">Compiler args</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>C FFI</span></li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Calling C</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#calling-ffi-functions">Calling FFI functions</a></li>
                
            
                <li class="toctree-l3"><a href="#safely-does-it">Safely does it</a></li>
                
            
                <li class="toctree-l3"><a href="#c-types">C types</a></li>
                
                    <li><a class="toctree-l4" href="#to-read-c-structs-from-ffi">To read c structs from FFI</a></li>
                
                    <li><a class="toctree-l4" href="#to-pass-c-structs-to-ffi">To pass c structs to FFI</a></li>
                
                    <li><a class="toctree-l4" href="#get-and-pass-pointers-to-ffi">Get and Pass Pointers to FFI</a></li>
                
            
                <li class="toctree-l3"><a href="#ffi-functions-raising-errors">FFI functions raising errors</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../linking-c/">Linking to C Libraries</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../c-abi/">C abi</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>The Runtime</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../runtime/otp/">Otp</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../runtime/memory-allocation/">Memory allocation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../runtime/garbage-collection/">Garbage collection</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../examples/examples/">Examples</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Pony Tutorial</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>C FFI &raquo;</li>
        
      
    
    <li>Calling C</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>Pony supports integration with other native languages through the
Foreign Function Interface (FFI). The FFI library provides a stable
and portable API and high level programming interface allowing Pony
to integrate with native libraries easily.</p>
<p>Note that calling C (or other low level languages) is inherently dangerous. C code fundamentally has access to all memory in the process and can change any of it, either deliberately or due to bugs. This is one of the language's most useful, but also most dangerous, features. Calling well written, bug free, C code will have no ill effects on your program. However, calling buggy or malicious C code or calling C incorrectly can cause your Pony program to go wrong, including corrupting data and crashing. Consequently all of Pony guarantees regarding not crashing, memory safety and concurrent correctness can be voided by calling FFI functions.</p>
<h1 id="calling-ffi-functions">Calling FFI functions</h1>
<p>FFI is built into Pony and native libraries may be directly referenced
in Pony code. There is no need to code or configure bindings, wrappers or interfaces.</p>
<p>Here's an example of an FFI call in Pony from the standard library. It looks like a normal method call, with just a few differences:</p>
<pre><code class="pony">@fwrite[U64](data.cstring(), U64(1), data.size(), _handle)
</code></pre>

<p>The main difference is the @ symbol before the function name. This is what tells us it's an FFI call. Any time you see an @ in Pony there's an FFI going on.</p>
<p>The other key difference is that the return type of the function is specified after the function name, in square brackets. This is because the compiler needs to know what type the value returned is (if any), but has no way to determine that, so it needs you to explicitly tell it.</p>
<p>There are a few unusual things going on with the arguments to this FFI call as well. For the second argument, for which we're passing the value 1, we've had to specify that this is a U64. Again this is because the compiler needs to know what size argument to use, but has no way to determine this.</p>
<h1 id="safely-does-it">Safely does it</h1>
<p><strong>It is VERY important that when calling FFI functions you MUST get the parameter and return types right</strong>. The compiler has no way to know what the native code expects and will just believe whatever you do. Errors here can cause invalid data to be passed to the FFI function or returned to Pony, which can lead to program crashes.</p>
<p>To help avoid bugs here Pony allows you to specify the type signatures of FFI functions in advance. Whilst you must still get the types correct the arguments you provide at each FFI call site are checked against the declared signature. This means that you must get a type wrong, in the same way, in at least 2 places for a bug to exist. This won't help if the argument types the native code expects are different to what you think they are, but it will protect you against trivial mistakes and simple typos.</p>
<p>FFI signatures are declared using the <code>use</code> command. Here's an example from the standard library:</p>
<pre><code class="pony">use @SSL_CTX_ctrl[I32](ctx: Pointer[_SSLContext] tag, op: I32, arg: I32,
  parg: Pointer[U8] tag) if windows

use @SSL_CTX_ctrl[I64](ctx: Pointer[_SSLContext] tag, op: I32, arg: I64,
  parg: Pointer[U8] tag) if not windows

class SSLContext val
  new create() =&gt;
    // set SSL_OP_NO_SSLv2
    @SSL_CTX_ctrl(_ctx, 32, 0x01000000, Pointer[U8])
</code></pre>

<p>The @ symbol tells us that the use command is an FFI signature declaration. The types specified here are considered authoritative and any FFI calls that differ are considered to be an error.</p>
<p>Note that we no longer need to specify the return type at the call site, since the signature declaration has already told us what it is. However, it is perfectly acceptable to specify it again if you want to.</p>
<p>The use @ command can take a condition just like other use commands. This is useful in this case, where the Windows version of SSL_CTX_ctrl has a slightly different signature to other platforms.</p>
<h1 id="c-types">C types</h1>
<p>Many C functions require types that don't have an exact equivalent in Pony. A variety of features are provided for these.</p>
<p>For FFI functions that have no return value (ie they return <code>void</code> in C) the return value specified should be <code>[None]</code>.</p>
<p>In Pony String is an object with a header and fields, but in C a <code>char*</code> is simply a pointer to character data. The <code>.cstring()</code> function on String provides us with a valid pointer to hand to C. Our fwrite example above makes use of this for the first argument.</p>
<p>Pony classes corresponds directly to pointers to the class in C.</p>
<p>For C pointers to simple types, such as U64, the Pony <code>Pointer[]</code> polymorphic type should be used, with a <code>tag</code> reference capability. <code>Pointer[U8] tag</code> should be used for void*. This can be seen in our <code>SSL_CTX_ctrl</code> example above.</p>
<p>To pass pointers to values to C the <code>addressof</code> operator can be used (previously <code>&amp;</code>), just like taking an address in C. This is done in the standard library to pass the address of a <code>U64</code> to an FFI function that takes a <code>uint64_t*</code> as an out parameter:</p>
<pre><code class="pony">var len = U64(0)
@pcre2_substring_length_bynumber_8[I32](_match, i.u32(), addressof len)
</code></pre>

<h2 id="to-read-c-structs-from-ffi">To read c structs from FFI</h2>
<p>If you have a c struct like this</p>
<pre><code class="c">typedef struct {
  uint8_t code;
  float x;
  float y;
} EGLEvent;

EGLEvent getEvent() {
    EGLEvent e = {1, ev.xconfigure.width, ev.xconfigure.height};
    return e;
}
</code></pre>

<p>the you can destructure it and get the values using a tuple</p>
<pre><code class="pony">type EGLEvent is (U8, F32, F32)
(var code, var x, var y) = @getEvent[EGLEvent]()
</code></pre>

<h2 id="to-pass-c-structs-to-ffi">To pass c structs to FFI</h2>
<p>If you have a c struct like this</p>
<pre><code class="c">typedef struct {
  uint8_t code;
  float x;
  float y;
} EGLEvent;

void setEvent(EGLEvent e) {
    printf(&quot;%d&quot;, e.code);
}
</code></pre>

<p>then you call it like this</p>
<pre><code class="pony">type EGLEvent is (U8, F32, F32)
let e: EGLEvent = (4, 0, 0)
@setEvent[None](e)
</code></pre>

<h2 id="get-and-pass-pointers-to-ffi">Get and Pass Pointers to FFI</h2>
<p>To pass and receive pointers to c structs you need to declare pointer to primitives</p>
<pre><code class="pony">primitive _XDisplayHandle
primitive _EGLDisplayHandle

let x_dpy = @XOpenDisplay[Pointer[_XDisplayHandle]](U32(0))
if x_dpy.is_null() then
  env.out.print(&quot;XOpenDisplay failed&quot;)
end

let e_dpy = @eglGetDisplay[Pointer[_EGLDisplayHandle]](x_dpy)
if e_dpy.is_null() then
  env.out.print(&quot;eglGetDisplay failed&quot;)
end
</code></pre>

<h1 id="ffi-functions-raising-errors">FFI functions raising errors</h1>
<p>FFI functions can raise Pony errors. Functions in existing C libraries are very unlikely to do this, but support libraries specifically written for use with Pony may well do.</p>
<p>FFI calls to functions that <strong>might</strong> raise an error <strong>must</strong> mark it as such by adding a ? after the arguments. For example:</p>
<pre><code class="pony">@os_send[U64](_event, data.cstring(), data.size()) ? // May raise an error
</code></pre>

<p>If a signature declaration is used then that must be marked as possibly raising an error in the same way. The FFI call site then does not have to mark it as well, although doing so is allowed.</p>
<pre><code class="pony">use @os_send[U64](ev: Event, buf: Pointer[U8] tag, len: U64) ?

@os_send(_event, data.cstring(), data.size()) // May raise an error
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../linking-c/" class="btn btn-neutral float-right" title="Linking to C Libraries"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../compiler-clargs/clargs/" class="btn btn-neutral" title="Compiler args"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../../compiler-clargs/clargs/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../linking-c/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
